================================
Data inalterability check report
================================

Tax authorities in some countries require companies to **prove their posted accounting entries are
inalterable**, meaning that once an entry has been posted, it can no longer be changed.

To do so, Odoo can use the **SHA-256 algorithm** to create a unique fingerprint for each posted
entry. This fingerprint is called a hash. The hash is generated by taking an entry's essential data
(the values of the `name`, `date`, `journal_id`, `company_id`, `debit`, `credit`, `account_id`, and
`partner_id` fields), concatenating it, and inputting it to the SHA-256 hash function, which then
outputs a fixed size (256-bit) string of characters. The hash function is deterministic (:dfn:`the
same input always creates the same output`): any minor modification to the original data would
completely change the resulting hash. Consequently, the SHA-256 algorithm is often used, among
others, for data integrity verification purposes.

In addition, the previous entry's hash is always added to the next entry to form a **hash chain**.
This is used to ensure a new entry is not added afterward between two posted entries, as doing so
would break the hash chain.

.. note::
   Hashes generated by the SHA-256 algorithm are theoretically not unique, as there is a finite
   number of possible values. However, this number is exceptionally high: 2²⁵⁶, which is a lot
   bigger than the number of atoms in the known universe. This is why hashes are considered unique
   in practice.

.. _data-inalterability/restricted:

Secure posted entries with hash
===============================

To start using the hashing function, go to :menuselection:`Accounting --> Configuration > Journals`.
Open the journal for which you want to activate the feature, go to the :guilabel:`Advanced Settings`
tab, and enable :guilabel:`Secure Posted Invoices with Hash`. We call journals for which the
feature is activated "restricted".
This feature is available for sale, purchase, and general journals.

To compute the hash of an entry, Odoo retrieves the predecessor entries of the chain (i.e., the
entries with the same sequence prefix) and hashes them in a continuous way from the last hashed
entry to the new entry to hash.

.. warning::
   Once you post an entry in a restricted journal, you cannot disable the feature anymore, nor edit any
   secured entry.

.. _data-inalterability/inalterability_features:

Inalterability Features
=======================

Some Inalterability Features are hidden by default.
They can be shown by activating the :guilabel:`Secure Posted Invoices with Hash` option on
any journal or using the :ref:`Secure Entries Wizard <data-inalterability/wizard>`.

- Two indicators are added to the journal entry form view.
  They show whether the entry is secured or not.

  - A lock next to the "Posted" state.
  - A "Secured" checkbox in the "Other info"

- On journal entry list views a "Not Secured" filter is shown.
  It can be used to find journal entries that are posted but not secured yet.
- The menu to open the :ref:`Secure Entries Wizard <data-inalterability/wizard>` is visible.

.. _data-inalterability/wizard:

Secure Entries Wizard
=====================

To secure journal entries in all journals up to a selected date the :guilabel:`Secure Entries` Wizard
can be used.

.. note::
   The wizard operates independently of the journal settings and journal types.
   It secures all entries in all journals.

To open it, activate the :ref:`developer mode <developer-mode>`,
go to :menuselection:`Accounting --> Accounting` and click on :guilabel:`Secure Entries`.
In case the :ref:`Inalterability Features <data-inalterability/inalterability_features>` are activated
it is also visible outside the debug mode.

To secure entries, select a date up to which all entries should be secured and press :guilabel:`Secure Entries`.

.. warning::
   After securing the entries you will not be able to edit them any more.

.. note::
   It can happen that entries are secured that are past the selected date.
   This is possible since the hash chain corresponds to the sequence prefix, ordered by sequence number.
   Thus it can be necessary to hash an entry with a lower sequence number (but higher accounting date).

.. note::
   It can happen that some entries can not be secured.
   This is possible since the hash chain corresponds to the sequence prefix, ordered by sequence number.
   Thus we can only extend the hash chain with entries that have a higher sequence number than the current chain.
   In previous versions it was for example possible to have unhashed entries at the start of a sequence prefix.
   Such entries can be protected from modification by setting the Hard Lock Date.

.. _data-inalterability/report:

Report download
===============

To download the data inalterability check report, go to :menuselection:`Accounting --> Configuration
--> Settings --> Reporting` and click on :guilabel:`Download the Data Inalterability Check Report`.

The report's first section is an overview of all your journals, their configuration and whether
they contain secured entries. Under the inalterability check column, you can see whether or not a journal
is restricted (V) or not (X). The coverage column tells you when a journal's entries started being secured.

.. image:: data_inalterability/journal-overview.png
   :align: center
   :alt: Configuration report for two journals

The second section gives you the result of the data consistency check for each hashed journal. You
can view the first hashed entry and its corresponding hash and the last hashed entry and its
corresponding hash.

.. image:: data_inalterability/data-consistency-check.png
   :align: center
   :alt: Data consistency check report for a journal
